<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bienvenido</title>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"
      defer
    ></script>
    <script defer>
      let decodedToken;
      let cicloActivoGlobal;
      let materiaSeleccionadaId;

      window.onload = async function () {
        const token = localStorage.getItem("token");

        if (!token) {
          window.location.href = "/login.html";
          return;
        }

        try {
            decodedToken = jwt_decode(token);
            mostrarNombreProfesor(decodedToken);
            await cargarCicloActivo(token);
            console.log("aqui");
            console.log(token);
            await cargarGrados(token);
            console.log("aqui");
        } catch (error) {
            console.error("Error al decodificar el token o cargar datos:", error); // Muestra el error en la consola
        }


        document
          .getElementById("cargar-alumnos-button")
          .addEventListener("click", cargarAlumnos);
      };

      function mostrarNombreProfesor(tokenDecodificado) {
        const nombreProfesor =
          tokenDecodificado.nombre_completo || "Campo nombre_completo no encontrado";
        document.getElementById("nombre_usuario").textContent = nombreProfesor;
      }

      async function cargarCicloActivo(token) {
        const responseCiclo = await fetch("/obtener-ciclos-escolares", {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (responseCiclo.ok) {
          cicloActivoGlobal = await responseCiclo.json();
          const cicloActivoSpan = document.getElementById("ciclo_activo");
          cicloActivoSpan.textContent = `Ciclo: ${cicloActivoGlobal.inicio_ciclo} - ${cicloActivoGlobal.fin_ciclo}`;
        }
      }

      async function cargarGrados(token) {
          const responseGrados = await fetch("/obtener-grados-profesor", {
              headers: {
                  Authorization: `Bearer ${token}`,
              },
          });
          if (responseGrados.ok) {
              const grados = await responseGrados.json();
              const selectGrados = document.getElementById("grados");
              console.log("aqui");
              // Limpiar las opciones anteriores
              selectGrados.innerHTML = ""; 

              grados.forEach((grado) => {
                  const option = document.createElement("option");
                  option.value = grado.id;
                  option.textContent = grado.descripcion;
                  selectGrados.appendChild(option);
              });

              selectGrados.addEventListener("change", async (event) => {
                  const gradoId = event.target.value;
                  if (gradoId) {
                      await cargarMaterias(token, gradoId);
                  }
              });

              // Limpiar cualquier mensaje de error anterior
              errorMessage.textContent = ""; 
          } else {
              const errorText = await responseGrados.text(); // Obtener el texto del error
              errorMessage.textContent = "Error al cargar los grados: " + errorText; // Mostrar el error en la interfaz
          }
      }


      async function cargarMaterias(token, gradoId) {
        const response = await fetch(`/obtener-materias-profesor-grado?grado_id=${gradoId}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (response.ok) {
          const materias = await response.json();
          const selectMaterias = document.getElementById("materias");
          selectMaterias.innerHTML = "";

          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "Selecciona una materia";
          defaultOption.disabled = true;
          defaultOption.selected = true;
          selectMaterias.appendChild(defaultOption);

          materias.forEach((materia) => {
            const option = document.createElement("option");
            option.value = materia.materia_id;
            option.textContent = materia.materia_nombre;
            selectMaterias.appendChild(option);
          });

          selectMaterias.addEventListener("change", (event) => {
            materiaSeleccionadaId = event.target.value;
          });
        }
      }

      async function cargarAlumnos() {
        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const gradoId = document.getElementById("grados").value;
          const cicloId = cicloActivoGlobal.id;
          const profesorId = decodedToken.profesor_id;

          if (!gradoId || !profesorId) return;

          const calificaciones = await obtenerCalificaciones(cicloId, gradoId, profesorId);
          const periodos = await obtenerPeriodos(cicloId);
          const periodoActivo = periodos.find(esPeriodoActivo);

          if (periodoActivo) {
            mostrarToast(
              `Periodo de captura activo: Desde ${new Date(
                periodoActivo.fecha_inicio
              ).toLocaleDateString()} hasta ${new Date(
                periodoActivo.fecha_fin
              ).toLocaleDateString()}`,
              "success"
            );
          } else {
            mostrarToast("No hay ningún periodo de captura activo en este momento.", "warning");
          }

          actualizarTablaAlumnos(calificaciones, periodos);
        } catch (error) {
          // Manejar error de carga de alumnos
        }
      }

      async function obtenerCalificaciones(cicloId, gradoId, profesorId) {
        const response = await fetch(
          `/calificaciones?id_ciclo_escolar=${cicloId}&id_grado_nivel_escolar=${gradoId}&id_profesor=${profesorId}&id_materia=${materiaSeleccionadaId}`
        );
        return response.json();
      }

      async function obtenerPeriodos(cicloId) {
        const response = await fetch(`/periodos?id_ciclo_escolar=${cicloId}`);
        return response.json();
      }

      function actualizarTablaAlumnos(calificaciones, periodos) {
          const tableBody = document.getElementById("alumnos-table").querySelector("tbody");
          tableBody.innerHTML = "";

          calificaciones.forEach((calificacion) => {
              const row = document.createElement("tr");

              row.innerHTML = `
                  <td>${calificacion.id_calificacion}</td>
                  <td>${calificacion.id_alumno}</td>
                  <td>${document.getElementById("materias").selectedOptions[0].text}</td>
                  <td>${calificacion.nombre_completo}</td>
              `;

              row.appendChild(crearCeldaDropdown(calificacion.periodo_1, periodos[0], 1));
              row.appendChild(crearCeldaDropdown(calificacion.periodo_2, periodos[1], 2));
              row.appendChild(crearCeldaDropdown(calificacion.periodo_3, periodos[2], 3));

              tableBody.appendChild(row);
          });
      }


      function crearCeldaDropdown(calificacionActual, periodo, periodoNumero) {
        const cell = document.createElement("td");
        cell.appendChild(crearDropdown(calificacionActual, periodo, periodoNumero));
        return cell;
      }

      function crearDropdown(calificacionActual, periodo, periodoNumero) {
        const select = document.createElement("select");

        const calificacionesPosibles = [0, 7, 8, 9, 10];
        calificacionesPosibles.forEach((calificacion) => {
          const option = document.createElement("option");
          option.value = calificacion;
          option.textContent = calificacion;
          option.selected = calificacion === calificacionActual;
          select.appendChild(option);
        });

        select.disabled = !esPeriodoActivo(periodo);
        select.onchange = function () {
          guardarCalificacion(this);
        };

        return select;
      }

      function esPeriodoActivo(periodo) {
        const fechaActual = new Date();
        const fechaInicio = new Date(periodo.fecha_inicio);
        const fechaFin = new Date(periodo.fecha_fin);
        return fechaActual >= fechaInicio && fechaActual <= fechaFin;
      }

      function mostrarToast(mensaje, tipo = "success") {
        const toastContainer = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.classList.add("toast", tipo);
        toast.textContent = mensaje;
        toastContainer.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("show");
        }, 100);

        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 5000);
      }

      function guardarCalificacion(selectElement) {
        const nuevaCalificacion = selectElement.value;
        const idAlumno = selectElement.closest("tr").children[1].textContent;
        const idMateria = document.getElementById("materias").value;

        // Implementar lógica para guardar calificación
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }

      document.addEventListener("DOMContentLoaded", function () {
        const logoutButton = document.getElementById("logout-button");
        if (logoutButton) {
          logoutButton.addEventListener("click", logout);
        }
      });
    </script>
  </head>
  <body>
    <div id="header" style="display: flex; flex-direction: column; width: 100%">
      <!-- Fila 1: Bienvenida, Ciclo Activo y Cerrar Sesión -->
      <div
        id="welcome-message"
        style="display: flex; justify-content: space-between; align-items: center; width: 90%; height: 40px;"
      >

        <img
          src="https://cdn.glitch.global/053303b6-9407-4474-b212-bccd4a7b7e5d/MarcaLDV.png?v=1728659537627"
          alt="Logo"
          style="width: 300px; margin-right: 20px;"/>
        <div style="flex: 1; text-align: left; margin-right: 20px;">
          <h1 style="margin: 0; font-size: 18px;">Bienvenido, <span id="nombre_usuario"></span></h1>
        </div>
        <div style="flex: 1; text-align: center; margin-right: 20px;">
          <span id="ciclo_activo" style="font-weight: bold"></span>
        </div>
        <div style="flex: 1; text-align: right;">
          <button id="logout-button">Cerrar sesión</button>
        </div>
      </div>

      <!-- Fila 2: Dropdowns de Grado, Materia y Botón Cargar Alumnos -->
      <div style="display: flex; align-items: center; margin-top: 20px">
        <label for="grados" style="margin-right: 10px; font-size: 12px">Selecciona un grado:</label>
        <select id="grados" style="margin-right: 20px">
          <option value="" disabled selected>Selecciona un grado</option>
        </select>

        <label for="materias" style="margin-right: 10px; font-size: 12px">Selecciona una materia:</label>
        <select id="materias" style="margin-right: 20px">
          <option value="" disabled selected>Selecciona una materia</option>
        </select>

        <button id="cargar-alumnos-button" style="margin-left: 20px">Cargar Alumnos</button>
      </div>
    </div>

    <div class="table-container">
        <table id="alumnos-table">
            <thead>
                <tr>
                    <th>ID Calificacion</th>
                    <th>ID Alumno</th>
                    <th>Materia</th>
                    <th>Nombre</th>
                    <th>Periodo 1</th>
                    <th>Periodo 2</th>
                    <th>Periodo 3</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí van tus filas de datos -->
            </tbody>
        </table>
    </div>
    <div id="toast-container" class="toast-container"></div>
  </body>
</html>
